<import template="/panel/_header"/>
<style type="text/css">
    .disabled {
    }
    .disabled optgroup{
        font-size: 12px;
        font-style: normal;
        font-weight: normal;
        font-variant: normal;
        color:#CCCCCC;
        background-color: #F5F5F5;
    }
    .disabled option {
        padding-left:0px;
    }
</style>
<div class="page-container">
    <div class="main-content">
        <div class="page-title">

            <div class="title-env">
                <h1 class="title">修改密码</h1>
                <p class="description">修改网站登录密码, 请妥善保管</p>
            </div>

            <div class="breadcrumb-env">
                <ol class="breadcrumb bc-1">
                    <li>
                        <a href="/member"><i class="fa-home"></i>主页</a>
                    </li>
                    <li>
                        <a href="javascript:;">我的信息</a>
                    </li>
                    <li class="active">
                        <strong>修改密码</strong>
                    </li>
                </ol>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-12 col-md-6 col-lg-6">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <i class="fa fa-angle-right"></i>&nbsp;网站登录密码
                    </div>
                    <div class="panel-body">
                        <div class="form-group">
                            <label for="nowpwd" class="control-label">旧密码：</label>
                            <input type="password" class="form-control" id="nowpwd" placeholder="旧密码">
                        </div>
						<div class="form-group">
							<label for="pwd" class="control-label">新密码：</label>
                            <input type="password" class="form-control" id="pwd" placeholder="新密码">
						</div>
						<div class="form-group">
                            <label for="repwd" class="control-label">确认新密码：</label>
                            <input type="password" class="form-control" id="repwd" placeholder="再次输入新密码">
						</div>
                    </div>
                    <button class="btn btn-info btn-block" id="submit-pwd">确定修改</button>
                </div>
            </div>
            <!-- change sspwd -->
            <div class="col-sm-12 col-md-6 col-lg-6">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <i class="fa fa-angle-right"></i>&nbsp;SSR连接设置
                    </div>
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label for="sspwd" class="control-label">连接密码(留空则随机生成)：</label>
                                    <input type="text" class="form-control" id="sspwd" value="{$user->sspwd}"
                                           placeholder="仅支持 英文+数字">
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label for="ssmethod" class="control-label">加密方式：</label>
                                    <select name="ssmethod" id="ssmethod" class="form-control">
                                        <loop variable="$custom_method_list" key="$key" value="$value">
                                            <option value="{$value}" <if condition="$user->method == $value">selected</if>>{$value}</option>
                                        </loop>
                                    </select>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label for="ssobfs" class="control-label">混淆：</label>
                                    <select name="ssobfs" id="ssobfs" class="form-control">
                                        <loop variable="$custom_obfs_list" key="$key" value="$value">
                                            <option value="{$value}" <if condition="$user->obfs == $value">selected</if>>{$value}</option>
                                        </loop>
                                    </select>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label for="ssobfsparam" class="control-label">混淆参数：</label>
                                    <input type="text" id="ssobfsparam" class="form-control" value="{$user->obfsparam}">
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label for="ssprotocol" class="control-label">协议：</label>
                                    <select name="ssprotocol" id="ssprotocol" class="form-control">
                                        <loop variable="$custom_protocol_list" key="$key" value="$value">
                                            <option value="{$value}" <if condition="$user->protocol == $value">selected</if>>{$value}</option>
                                        </loop>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div><span><code>注意：带有 compatible 的即兼容模式，修改连接参数后各服务器数据同步可能不及时，可能会导致某些服务节点连接不上，密码错误等(约5分钟时
间全服务器同步)。</code></span></div>
                    <br/>
                    <button class="btn btn-info btn-block" id="submit-sspwd">确定修改</button>
                </div>
            </div>
        </div>
        <script>
            $(document).ready(function () {
                $("#submit-pwd").click(function () {
                    var but = $(this);
                    var nowpwd = $("#nowpwd").val();
                    var pwd = $("#pwd").val();
                    var repwd = $("#repwd").val();
                    if (nowpwd == null || nowpwd == '') {
                        showToastr("旧密码不能为空", 0, 2000);
                        return;
                    }
                    if (pwd == null || pwd == '' || repwd == null || repwd == '') {
                        showToastr("喂喂，新密码不能为空诶！", 0, 2000);
                        return;
                    }
                    if (pwd != repwd && pwd != null && repwd != null) {
                        showToastr("两次密码不一致", 0, 2000);
                        return;
                    }
                    but.attr('disabled', 'true').addClass('disabled');
                    $.ajax({
                        type: "POST",
                        url: "/member/changePassWord.json",
                        data: {
                            'nowpwd': nowpwd,
                            'pwd': pwd,
                            'repwd': repwd
                        },
                        dataType: "json",
                        success: function (result) {
                            but.removeAttr('disabled').removeClass('disabled');
                            if (result.code != 200) {
                                showToastr(result.message, 0, 5000, '系统错误');
                                return;
                            }
                            if (result.data.error == 0) {
                                setTimeout("window.location.href='/auth/login'", 3000);
                            }
                            showToastr(result.data.message, 0, 5000);
                        },
                        error: function (jqXHR) {
                            but.removeAttr('disabled').removeClass('disabled');
                            showToastr("发生错误：" + jqXHR.status, 0);
                        }
                    })
                });
                $("#submit-sspwd").click(function () {
                    var but = $(this);
                    var sspwd = $("#sspwd").val();
                    var ssmethod = $("#ssmethod").val();
                    var ssprotocol = $("#ssprotocol").val();
                    var ssobfs = $("#ssobfs").val();
                    var ssobfsparam = $("#ssobfsparam").val();

                    if (/.*[\u4e00-\u9fa5]+.*$/.test(sspwd)){
                        alert("连接密码仅支持 英文+数字");
                        return;
                    }
                    if (sspwd == null || sspwd == '') {
                        /*
                         showToastr("Shadowsocks连接密码不能为空", 0, 2000);
                         return;
                         */
                        var flags = confirm("如果连接密码留空，将随机生成连接密码，请问真的要这么做吗？");
                        if (!flags) {
                            return;
                        }
                        sspwd = '1';
                    }
                    but.attr('disabled', 'true').addClass('disabled');
                    $.ajax({
                        type: "POST",
                        url: "/member/changeSSPwd.json",
                        data: {
                            'sspwd': sspwd,
                            'ssmethod': ssmethod,
                            'ssprotocol': ssprotocol,
                            'ssobfs': ssobfs,
                            'ssobfsparam': ssobfsparam,
                        },
                        dataType: "json",
                        success: function (result) {
                            if (result.code != 200) {
                                showToastr(result.message, 0, 5000, '系统错误');
                                return;
                            }
                            if (result.data.error == 0) {
                                $("#sspwd").val(result.data.sspwd);
                            }

                            but.removeAttr('disabled').removeClass('disabled');
                            showToastr(result.data.message, 0, 5000);
                        },
                        error: function (jqXHR) {
                            showToastr("发生错误：" + jqXHR.status, 0);
                            but.removeAttr('disabled').removeClass('disabled');
                        }
                    })
                });
                $('#ssprotocol').on('change', function() {
                    var that = $(this);
                    if (that.val() == 'auth_chain_a') {
                        $('#ssmethod').append('<optgroup label="auth_chain_a"><option value="none">none</option></optgroup>').val('none').attr('disabled', true);
                        /*如果 .val 设置选中失败，保险起见用别的方式在设置一次*/
                        $("#ssmethod").find("option[value='none']").attr("selected",true);
                    } else {
                        $('#ssmethod optgroup[label="auth_chain_a"]').remove();
                        $('#ssmethod').removeAttr('disabled');
                    }
                });
                /*加载页面后检查用户的 protocol 选择，若为 auth_chain_a 则自动触发 #ssprotocol onChange 事件来禁止 加密方式的选择功能*/
                if ($('#ssprotocol').val() == 'auth_chain_a') {
                    $('#ssprotocol').trigger('change');
                }
            });
        </script>
        <import template="/panel/_copyright"/>
    </div>
</div>
<import template="/panel/_footer"/>